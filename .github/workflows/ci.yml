name: ClearVision CI/CD

on:
  push:
    branches: [ "main", "develop" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (例如: 1.0.0)'
        required: false
        default: ''

env:
  SOLUTION_PATH: Acme.Product/Acme.Product.sln
  DESKTOP_PROJECT: Acme.Product/src/Acme.Product.Desktop/Acme.Product.Desktop.csproj
  PUBLISH_DIR: ./publish

jobs:
  # ==========================================
  # 构建和测试
  # ==========================================
  build-and-test:
    name: Build & Test
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore Dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    # Debug 构建和测试
    - name: Build (Debug)
      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Debug --no-restore

    - name: Run Unit Tests
      run: dotnet test ${{ env.SOLUTION_PATH }} --configuration Debug --no-build --verbosity normal --logger trx

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: '**/*.trx'

    # UI 测试
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install UI Test Dependencies
      working-directory: Acme.Product/tests/Acme.Product.UI.Tests
      run: |
        npm ci
        npx playwright install --with-deps chromium

    - name: Run UI Tests
      working-directory: Acme.Product/tests/Acme.Product.UI.Tests
      run: npx playwright test

    - name: Upload UI Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ui-test-results
        path: |
          Acme.Product/tests/Acme.Product.UI.Tests/playwright-report/
          Acme.Product/tests/Acme.Product.UI.Tests/test-results/

  # ==========================================
  # 发布构建
  # ==========================================
  release-build:
    name: Release Build
    runs-on: windows-latest
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore Dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    # 确定版本号
    - name: Get Version
      id: version
      shell: pwsh
      run: |
        if ('${{ github.event.inputs.version }}') {
          $version = '${{ github.event.inputs.version }}'
        } elseif ('${{ github.ref }}' -match 'refs/tags/v(.+)') {
          $version = $matches[1]
        } else {
          $version = '1.0.0-' + (Get-Date -Format 'yyyyMMdd-HHmmss')
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        Write-Host "Building version: $version"

    # 发布单文件版本
    - name: Publish Single File
      run: |
        dotnet publish ${{ env.DESKTOP_PROJECT }} `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:PublishReadyToRun=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -p:Version=${{ steps.version.outputs.VERSION }} `
          -o "${{ env.PUBLISH_DIR }}/ClearVision-${{ steps.version.outputs.VERSION }}"

    # 创建启动脚本
    - name: Create Launcher Script
      shell: pwsh
      run: |
        $content = "@echo off`nchcp 65001 >nul`necho 正在启动 ClearVision...`nstart `"`" `"%~dp0Acme.Product.Desktop.exe`""
        $content | Out-File -FilePath "${{ env.PUBLISH_DIR }}/ClearVision-${{ steps.version.outputs.VERSION }}/启动 ClearVision.bat" -Encoding UTF8

    # 打包为 ZIP
    - name: Create ZIP Archive
      shell: pwsh
      run: |
        Compress-Archive -Path "${{ env.PUBLISH_DIR }}/ClearVision-${{ steps.version.outputs.VERSION }}/*" -DestinationPath "${{ env.PUBLISH_DIR }}/ClearVision-${{ steps.version.outputs.VERSION }}-win-x64.zip" -Force

    # 上传构建产物
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ClearVision-Build-${{ steps.version.outputs.VERSION }}
        path: ${{ env.PUBLISH_DIR }}/ClearVision-${{ steps.version.outputs.VERSION }}-win-x64.zip
        retention-days: 30

  # ==========================================
  # 创建 Release
  # ==========================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: release-build
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download Build Artifact
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: ./artifacts/**/*.zip
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================
  # 代码质量检查
  # ==========================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore Dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: Build
      run: dotnet build ${{ env.SOLUTION_PATH }} --no-restore

    # 使用 dotnet format 检查代码格式
    - name: Check Code Format
      run: |
        dotnet format ${{ env.SOLUTION_PATH }} --verify-no-changes --verbosity diagnostic || true

    # 静态分析
    - name: Run Static Analysis
      run: |
        dotnet build ${{ env.SOLUTION_PATH }} -p:TreatWarningsAsErrors=false -warnaserror || true