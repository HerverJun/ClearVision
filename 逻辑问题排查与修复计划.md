# ClearVision é¡¹ç›®é€»è¾‘é—®é¢˜æ’æŸ¥ä¸ä¿®å¤è®¡åˆ’

> åˆ›å»ºæ—¶é—´ï¼š2026-02-08  
> æ’æŸ¥èŒƒå›´ï¼šåç«¯æ ¸å¿ƒæœåŠ¡ã€åŸºç¡€è®¾æ–½å±‚ã€WebView2é›†æˆ  
> çŠ¶æ€ï¼šå¾…ä¿®å¤

---

## ä¸€ã€æ’æŸ¥æ¦‚è§ˆ

### 1.1 é¡¹ç›®ç°çŠ¶
- **ä»£ç è§„æ¨¡**ï¼šC# 12,389è¡Œï¼ˆ111æ–‡ä»¶ï¼‰ï¼ŒJavaScript 5,535è¡Œï¼ˆ34æ–‡ä»¶ï¼‰
- **æµ‹è¯•è¦†ç›–**ï¼š85+ å•å…ƒæµ‹è¯•ï¼Œ100%é€šè¿‡ç‡
- **æŠ€æœ¯æ ˆ**ï¼š.NET 8 + WebView2 + OpenCvSharp4 + SQLite
- **æ¶æ„æ¨¡å¼**ï¼šé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰åˆ†å±‚æ¶æ„

### 1.2 å‘ç°çš„é—®é¢˜æ±‡æ€»

| ä¼˜å…ˆçº§ | é—®é¢˜æ•° | çŠ¶æ€ |
|--------|--------|------|
| ğŸ”´ P0 - ä¸¥é‡ | 1 | å¾…ä¿®å¤ |
| ğŸŸ¡ P1 - ä¸­ç­‰ | 3 | å¾…ä¿®å¤ |
| ğŸŸ¢ P2 - è½»å¾® | 2 | å¯é€‰ä¿®å¤ |

---

## äºŒã€P0 ä¸¥é‡é—®é¢˜ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

### 2.1 ã€é—®é¢˜ #P0-001ã€‘æµç¨‹æ‰§è¡Œå–æ¶ˆæœºåˆ¶ä¸å®Œæ•´

**æ–‡ä»¶ä½ç½®**ï¼š`Acme.Product.Infrastructure/Services/FlowExecutionService.cs:405`

**å½“å‰ä»£ç **ï¼š
```csharp
public Task CancelExecutionAsync(Guid flowId)
{
    // TODO: å®ç°å–æ¶ˆé€»è¾‘
    if (_executionStatuses.TryGetValue(flowId, out var status))
    {
        status.IsExecuting = false;
    }
    return Task.CompletedTask;
}
```

**é—®é¢˜åˆ†æ**ï¼š
1. âŒ åªæ˜¯è®¾ç½®çŠ¶æ€æ ‡å¿—ï¼Œæ²¡æœ‰çœŸæ­£å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
2. âŒ æ²¡æœ‰ä¼ é€’ CancellationToken ç»™ç®—å­æ‰§è¡Œå™¨
3. âŒ æ­£åœ¨æ‰§è¡Œçš„ç®—å­ä¼šç»§ç»­è¿è¡Œï¼Œæµªè´¹èµ„æº
4. âŒ æ— æ³•å“åº”ç”¨æˆ·çš„å–æ¶ˆè¯·æ±‚

**å½±å“**ï¼š
- ç”¨æˆ·ç‚¹å‡»"å–æ¶ˆ"åï¼Œæµç¨‹å®é™…ä¸Šè¿˜åœ¨ç»§ç»­æ‰§è¡Œ
- å¯èƒ½å¯¼è‡´èµ„æºæ³„æ¼ï¼ˆå›¾åƒç¼“å­˜ã€å†…å­˜ï¼‰
- å¹¶å‘åœºæ™¯ä¸‹å¯èƒ½äº§ç”Ÿç«æ€æ¡ä»¶

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```csharp
// 1. æ·»åŠ  CancellationTokenSource å­—å…¸
private readonly ConcurrentDictionary<Guid, CancellationTokenSource> _executionCancellations = new();

// 2. ä¿®æ”¹ ExecuteFlowAsync æ–¹æ³•
public async Task<FlowExecutionResult> ExecuteFlowAsync(
    OperatorFlow flow, 
    Dictionary<string, object>? inputData = null, 
    bool enableParallel = false,
    CancellationToken cancellationToken = default)  // æ·»åŠ å¤–éƒ¨å–æ¶ˆä»¤ç‰Œ
{
    var cts = CancellationTokenSource.CreateLinkedTokenSource(cancellationToken);
    _executionCancellations[flow.Id] = cts;
    
    try
    {
        // åœ¨ç®—å­æ‰§è¡Œæ—¶ä¼ é€’ cts.Token
        var opResult = await ExecuteOperatorInternalAsync(op, executor, inputs, cts.Token);
        
        // å®šæœŸæ£€æŸ¥å–æ¶ˆçŠ¶æ€
        if (cts.Token.IsCancellationRequested)
        {
            result.IsSuccess = false;
            result.ErrorMessage = "æµç¨‹å·²è¢«ç”¨æˆ·å–æ¶ˆ";
            return result;
        }
    }
    finally
    {
        _executionCancellations.TryRemove(flow.Id, out _);
        cts.Dispose();
    }
}

// 3. å®Œå–„å–æ¶ˆæ–¹æ³•
public Task CancelExecutionAsync(Guid flowId)
{
    if (_executionCancellations.TryGetValue(flowId, out var cts))
    {
        cts.Cancel();
        
        if (_executionStatuses.TryGetValue(flowId, out var status))
        {
            status.IsExecuting = false;
            status.ErrorMessage = "å·²å–æ¶ˆ";
        }
    }
    return Task.CompletedTask;
}
```

**éªŒè¯æ ‡å‡†**ï¼š
1. æ‰§è¡Œé•¿è€—æ—¶æµç¨‹æ—¶è°ƒç”¨ CancelExecutionAsyncï¼Œä»»åŠ¡åº”åœ¨ 1 ç§’å†…åœæ­¢
2. å–æ¶ˆåæ‰€æœ‰ç›¸å…³èµ„æºåº”æ­£ç¡®é‡Šæ”¾
3. å•å…ƒæµ‹è¯•ï¼šå–æ¶ˆå IsExecuting åº”ä¸º falseï¼Œä¸”ä¸å†è¾“å‡ºç»“æœ

---

## ä¸‰ã€P1 ä¸­ç­‰é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

### 3.1 ã€é—®é¢˜ #P1-001ã€‘å›¾åƒé‡‡é›†æœåŠ¡ä½¿ç”¨ Console.WriteLine è€Œé ILogger

**æ–‡ä»¶ä½ç½®**ï¼š`Acme.Product.Infrastructure/Services/ImageAcquisitionService.cs:230`

**å½“å‰ä»£ç **ï¼š
```csharp
catch (Exception ex)
{
    // è®°å½•é”™è¯¯ä½†ç»§ç»­é‡‡é›†
    // TODO: ä½¿ç”¨ ILogger æ›¿ä»£ Console.WriteLine
    System.Diagnostics.Debug.WriteLine($"[ImageAcquisitionService] è¿ç»­é‡‡é›†é”™è¯¯: {ex.Message}");
    await Task.Delay(frameInterval, cts.Token);
}
```

**é—®é¢˜åˆ†æ**ï¼š
1. âŒ ä½¿ç”¨ Debug.WriteLine è€Œéç»“æ„åŒ–çš„ ILogger
2. âŒ æ— æ³•é€šè¿‡ Serilog é…ç½®æ§åˆ¶æ—¥å¿—çº§åˆ«
3. âŒ æ—¥å¿—æ— æ³•è¢«æŒä¹…åŒ–åˆ°æ–‡ä»¶
4. âŒ ä¸ä¸€è‡´çš„æ—¥å¿—é£æ ¼

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```csharp
public class ImageAcquisitionService : IImageAcquisitionService, IDisposable
{
    private readonly ILogger<ImageAcquisitionService> _logger;  // æ·»åŠ æ—¥å¿—ä¾èµ–

    public ImageAcquisitionService(
        ICameraManager cameraManager, 
        ILogger<ImageAcquisitionService> logger)  // æ³¨å…¥ ILogger
    {
        _cameraManager = cameraManager;
        _logger = logger;
    }

    // åœ¨å¼‚å¸¸å¤„ç†ä¸­ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
    catch (Exception ex)
    {
        _logger.LogWarning(ex, "è¿ç»­é‡‡é›†å‘ç”Ÿé”™è¯¯ï¼Œå°†åœ¨ {FrameInterval}ms åé‡è¯•", frameInterval);
        await Task.Delay(frameInterval, cts.Token);
    }
}
```

**éªŒè¯æ ‡å‡†**ï¼š
1. æ—¥å¿—åº”å‡ºç°åœ¨ Serilog é…ç½®çš„æ—¥å¿—æ–‡ä»¶ä¸­
2. æ—¥å¿—çº§åˆ«åº”ä¸º Warningï¼ˆå› ä¸ºæ˜¯å¯æ¢å¤çš„é”™è¯¯ï¼‰
3. æ—¥å¿—åº”åŒ…å«å¸§é—´éš”ç­‰ä¸Šä¸‹æ–‡ä¿¡æ¯

---

### 3.2 ã€é—®é¢˜ #P1-002ã€‘å·¥ç¨‹ä»“å‚¨åŒ…å«è°ƒè¯•ç”¨çš„ Console.WriteLine

**æ–‡ä»¶ä½ç½®**ï¼š`Acme.Product.Infrastructure/Repositories/ProjectRepository.cs:97-104`

**å½“å‰ä»£ç **ï¼š
```csharp
// ã€è°ƒè¯•ã€‘æ‰“å°æ‰€æœ‰è¢«è¿½è¸ªçš„å®ä½“åŠå…¶çŠ¶æ€
Console.WriteLine("[DEBUG Repository] === Change Tracker Entries Before Save ===");
foreach (var entry in _context.ChangeTracker.Entries())
{
    var idProp = entry.Metadata.FindProperty("Id");
    var idValue = idProp != null ? entry.Property("Id")?.CurrentValue?.ToString() : "(no Id)";
    Console.WriteLine($"[DEBUG Repository] Entity: {entry.Entity.GetType().Name}, State: {entry.State}, Id: {idValue}");
}
Console.WriteLine("[DEBUG Repository] === End Change Tracker Entries ===");
```

**é—®é¢˜åˆ†æ**ï¼š
1. âŒ è°ƒè¯•ä»£ç ä¸åº”è¯¥å‡ºç°åœ¨ç”Ÿäº§ä»£ç ä¸­
2. âŒ æ¯æ¬¡ä¿å­˜å·¥ç¨‹éƒ½ä¼šè¾“å‡ºå¤§é‡è°ƒè¯•ä¿¡æ¯
3. âŒ æ²¡æœ‰ä½¿ç”¨ #if DEBUG æ¡ä»¶ç¼–è¯‘
4. âŒ å½±å“æ€§èƒ½å’Œæ—¥å¿—å¯è¯»æ€§

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```csharp
// æ–¹æ¡ˆ1ï¼šä½¿ç”¨æ¡ä»¶ç¼–è¯‘
#if DEBUG
_logger.LogDebug("=== Change Tracker Entries Before Save ===");
foreach (var entry in _context.ChangeTracker.Entries())
{
    var idValue = entry.Property("Id")?.CurrentValue?.ToString() ?? "(no Id)";
    _logger.LogDebug("Entity: {EntityType}, State: {State}, Id: {Id}", 
        entry.Entity.GetType().Name, entry.State, idValue);
}
#endif

// æ–¹æ¡ˆ2ï¼šåˆ é™¤è°ƒè¯•ä»£ç ï¼ˆæ¨èï¼‰
// è¿™äº›è°ƒè¯•ä»£ç å·²ç»å®Œæˆäº†è°ƒè¯•ç›®çš„ï¼Œç°åœ¨å¯ä»¥å®‰å…¨åˆ é™¤
```

**éªŒè¯æ ‡å‡†**ï¼š
1. RELEASE æ„å»ºä¸åº”è¾“å‡ºè°ƒè¯•ä¿¡æ¯
2. ä¿å­˜å·¥ç¨‹æ“ä½œæ€§èƒ½ä¸å—å½±å“

---

### 3.3 ã€é—®é¢˜ #P1-003ã€‘WebMessage æ¶ˆæ¯è·¯ç”±ä¸ºç©ºå®ç°

**æ–‡ä»¶ä½ç½®**ï¼š`Acme.Product.Desktop/WebView2Host.cs:227-251`

**å½“å‰ä»£ç **ï¼š
```csharp
private async Task HandleMessageAsync(WebMessage message)
{
    try
    {
        // TODO: å®ç°æ¶ˆæ¯è·¯ç”±å’Œå¤„ç†é€»è¾‘
        var response = new WebMessageResponse
        {
            RequestId = message.Id,
            Success = true,
            Data = null
        };

        await SendMessageAsync(response);
    }
    catch (Exception ex)
    {
        var errorResponse = new WebMessageResponse
        {
            RequestId = message.Id,
            Success = false,
            Error = ex.Message
        };

        await SendMessageAsync(errorResponse);
    }
}
```

**é—®é¢˜åˆ†æ**ï¼š
1. âŒ æ¶ˆæ¯è·¯ç”±æ˜¯ç©ºå®ç°ï¼Œæ— æ³•å¤„ç†å‰ç«¯å‘é€çš„æ¶ˆæ¯
2. âŒ WebMessageHandler å·²å­˜åœ¨ä½†æœªåœ¨ WebView2Host ä¸­ä½¿ç”¨
3. âŒ å‰ç«¯é€šè¿‡ WebMessage å‘é€çš„å‘½ä»¤æ— æ³•å¾—åˆ°å“åº”

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```csharp
private readonly WebMessageHandler? _messageHandler;

public WebView2Host(WebView2 webView, WebMessageHandler? messageHandler = null)
{
    _webView = webView ?? throw new ArgumentNullException(nameof(webView));
    _messageHandler = messageHandler;
}

private async Task HandleMessageAsync(WebMessage message)
{
    try
    {
        if (_messageHandler == null)
        {
            await SendMessageAsync(new WebMessageResponse
            {
                RequestId = message.Id,
                Success = false,
                Error = "æ¶ˆæ¯å¤„ç†å™¨æœªåˆå§‹åŒ–"
            });
            return;
        }

        // å§”æ‰˜ç»™ WebMessageHandler å¤„ç†
        var result = await _messageHandler.HandleAsync(message);
        
        await SendMessageAsync(new WebMessageResponse
        {
            RequestId = message.Id,
            Success = result.Success,
            Data = result.Data,
            Error = result.Error
        });
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "å¤„ç† Web æ¶ˆæ¯å¤±è´¥: {MessageType}", message.Type);
        
        await SendMessageAsync(new WebMessageResponse
        {
            RequestId = message.Id,
            Success = false,
            Error = $"æœåŠ¡å™¨å†…éƒ¨é”™è¯¯: {ex.Message}"
        });
    }
}
```

**éªŒè¯æ ‡å‡†**ï¼š
1. å‰ç«¯å‘é€ WebMessage åº”å¾—åˆ°æ­£ç¡®å“åº”
2. æ¶ˆæ¯å¤„ç†å™¨åº”æ­£ç¡®åˆ†å‘åˆ°å¯¹åº”çš„æœåŠ¡
3. é”™è¯¯æƒ…å†µåº”è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯

---

## å››ã€P2 è½»å¾®é—®é¢˜ï¼ˆå¯é€‰ä¿®å¤ï¼‰

### 4.1 ã€é—®é¢˜ #P2-001ã€‘WebView2Host ä¸­ä½¿ç”¨ InvokeRequired æ¨¡å¼è¾ƒæ—§

**æ–‡ä»¶ä½ç½®**ï¼š`Acme.Product.Desktop/WebView2Host.cs:297-304`

**å½“å‰ä»£ç **ï¼š
```csharp
// åœ¨ UI çº¿ç¨‹ä¸Šæ‰§è¡Œ
if (_webView.InvokeRequired)
{
    _webView.Invoke(() => _webView.CoreWebView2.PostWebMessageAsJson(json));
}
else
{
    _webView.CoreWebView2.PostWebMessageAsJson(json);
}
```

**é—®é¢˜åˆ†æ**ï¼š
- âš ï¸ ä»£ç åŠŸèƒ½æ­£ç¡®ï¼Œä½†å¯ä»¥ä½¿ç”¨æ›´ç°ä»£çš„ C# æ¨¡å¼
- âš ï¸ å¯ä»¥å°è£…ä¸ºæ‰©å±•æ–¹æ³•æé«˜å¤ç”¨æ€§

**ä¿®å¤æ–¹æ¡ˆï¼ˆå¯é€‰ï¼‰**ï¼š
```csharp
// åˆ›å»ºæ‰©å±•æ–¹æ³•
public static class WebView2Extensions
{
    public static void PostWebMessageOnUIThread(this WebView2 webView, string json)
    {
        if (webView.InvokeRequired)
        {
            webView.Invoke(() => webView.CoreWebView2?.PostWebMessageAsJson(json));
        }
        else
        {
            webView.CoreWebView2?.PostWebMessageAsJson(json);
        }
    }
}

// ä½¿ç”¨æ‰©å±•æ–¹æ³•
_webView.PostWebMessageOnUIThread(json);
```

---

### 4.2 ã€é—®é¢˜ #P2-002ã€‘ImageAcquisitionService çš„é”ç­–ç•¥å¯ä»¥ä¼˜åŒ–

**æ–‡ä»¶ä½ç½®**ï¼š`Acme.Product.Infrastructure/Services/ImageAcquisitionService.cs`

**é—®é¢˜åˆ†æ**ï¼š
- âš ï¸ ä½¿ç”¨ `lock (_imageCache)` è¿›è¡Œç²—ç²’åº¦é”å®š
- âš ï¸ `ConcurrentDictionary` å¯ä»¥æ›´å¥½åœ°å¤„ç†å¹¶å‘
- âš ï¸ `SemaphoreSlim _cacheLock` å·²å®šä¹‰ä½†æœªä½¿ç”¨

**å»ºè®®ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰**ï¼š
```csharp
// ä½¿ç”¨ ConcurrentDictionary çš„åŸå­æ“ä½œæ›¿ä»£ lock
private readonly ConcurrentDictionary<Guid, Mat> _imageCache = new();

// ç¼“å­˜å›¾åƒ
_imageCache[imageId] = mat.Clone();

// è·å–å›¾åƒ
if (_imageCache.TryGetValue(imageId, out var mat))
{
    // ä½¿ç”¨ mat
}

// é‡Šæ”¾å›¾åƒ
if (_imageCache.TryRemove(imageId, out var mat))
{
    mat.Dispose();
}
```

---

## äº”ã€ä¿®å¤æ‰§è¡Œè®¡åˆ’

### 5.1 ä¿®å¤ä¼˜å…ˆçº§æ’åº

| åºå· | é—®é¢˜ID | é—®é¢˜æè¿° | é¢„ä¼°å·¥æ—¶ | ä¾èµ–å…³ç³» |
|------|--------|----------|----------|----------|
| 1 | P0-001 | æµç¨‹æ‰§è¡Œå–æ¶ˆæœºåˆ¶ä¸å®Œæ•´ | 4h | æ—  |
| 2 | P1-001 | ImageAcquisitionService æ—¥å¿—é—®é¢˜ | 1h | æ—  |
| 3 | P1-002 | ProjectRepository è°ƒè¯•ä»£ç  | 0.5h | æ—  |
| 4 | P1-003 | WebMessage æ¶ˆæ¯è·¯ç”±ä¸ºç©º | 2h | æ—  |
| 5 | P2-001 | InvokeRequired æ¨¡å¼ä¼˜åŒ– | 1h | å¯é€‰ |
| 6 | P2-002 | é”ç­–ç•¥ä¼˜åŒ– | 2h | å¯é€‰ |

### 5.2 ä¿®å¤æ­¥éª¤

#### Phase 1: P0 ä¸¥é‡é—®é¢˜ä¿®å¤ï¼ˆå¿…é¡»å®Œæˆï¼‰

**ä»»åŠ¡ 1.1: å®Œå–„å–æ¶ˆæœºåˆ¶**
- [ ] åœ¨ FlowExecutionService ä¸­æ·»åŠ  `_executionCancellations` å­—å…¸
- [ ] ä¿®æ”¹ ExecuteFlowAsync æ–¹æ³•æ”¯æŒ CancellationToken
- [ ] ä¿®æ”¹ ExecuteOperatorInternalAsync ä¼ é€’ CancellationToken
- [ ] å®Œå–„ CancelExecutionAsync æ–¹æ³•å®ç°çœŸæ­£å–æ¶ˆ
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯å–æ¶ˆåŠŸèƒ½

#### Phase 2: P1 ä¸­ç­‰é—®é¢˜ä¿®å¤ï¼ˆå»ºè®®å®Œæˆï¼‰

**ä»»åŠ¡ 2.1: ä¿®å¤ ImageAcquisitionService æ—¥å¿—**
- [ ] æ·»åŠ  ILogger<ImageAcquisitionService> ä¾èµ–
- [ ] æ›¿æ¢ Debug.WriteLine ä¸º _logger.LogWarning
- [ ] éªŒè¯æ—¥å¿—è¾“å‡ºåˆ° Serilog æ–‡ä»¶

**ä»»åŠ¡ 2.2: æ¸…ç† ProjectRepository è°ƒè¯•ä»£ç **
- [ ] åˆ é™¤æˆ–æ·»åŠ  #if DEBUG æ¡ä»¶ç¼–è¯‘
- [ ] ä½¿ç”¨ ILogger æ›¿ä»£ Console.WriteLine

**ä»»åŠ¡ 2.3: å®ç° WebMessage æ¶ˆæ¯è·¯ç”±**
- [ ] ä¿®æ”¹ WebView2Host æ„é€ å‡½æ•°æ¥æ”¶ WebMessageHandler
- [ ] åœ¨ HandleMessageAsync ä¸­å§”æ‰˜ç»™ WebMessageHandler
- [ ] éªŒè¯å‰ç«¯æ¶ˆæ¯èƒ½æ­£ç¡®å¾—åˆ°å“åº”

#### Phase 3: P2 è½»å¾®é—®é¢˜ä¿®å¤ï¼ˆå¯é€‰ï¼‰

**ä»»åŠ¡ 3.1: UI çº¿ç¨‹è°ƒç”¨ä¼˜åŒ–**
- [ ] åˆ›å»º WebView2Extensions æ‰©å±•æ–¹æ³•
- [ ] æ›¿æ¢æ‰€æœ‰ InvokeRequired è°ƒç”¨

**ä»»åŠ¡ 3.2: å¹¶å‘ä¼˜åŒ–**
- [ ] è¯„ä¼°æ˜¯å¦å°† _imageCache æ”¹ä¸º ConcurrentDictionary
- [ ] å®ç°ç»†ç²’åº¦é”å®šæˆ–æ— é”å¹¶å‘

---

## å…­ã€æµ‹è¯•éªŒè¯è®¡åˆ’

### 6.1 å•å…ƒæµ‹è¯•è¦†ç›–

```csharp
// å–æ¶ˆåŠŸèƒ½æµ‹è¯•
[Fact]
public async Task ExecuteFlowAsync_WhenCancelled_ShouldStopExecution()
{
    // Arrange
    var flow = CreateLongRunningFlow();
    var cts = new CancellationTokenSource();
    
    // Act
    var executionTask = _service.ExecuteFlowAsync(flow, cancellationToken: cts.Token);
    cts.CancelAfter(100);  // 100ms åå–æ¶ˆ
    var result = await executionTask;
    
    // Assert
    result.IsSuccess.Should().BeFalse();
    result.ErrorMessage.Should().Contain("å–æ¶ˆ");
}

// æ—¥å¿—æµ‹è¯•
[Fact]
public async Task StartContinuousAcquisitionAsync_WhenError_ShouldLogWarning()
{
    // Arrange
    var mockLogger = new Mock<ILogger<ImageAcquisitionService>>();
    var service = new ImageAcquisitionService(_mockCameraManager.Object, mockLogger.Object);
    
    // Act & Assert
    mockLogger.Verify(
        x => x.Log(
            LogLevel.Warning,
            It.IsAny<EventId>(),
            It.Is<It.IsAnyType>((v, t) => v.ToString().Contains("è¿ç»­é‡‡é›†")),
            It.IsAny<Exception>(),
            It.IsAny<Func<It.IsAnyType, Exception, string>>()),
        Times.AtLeastOnce);
}
```

### 6.2 é›†æˆæµ‹è¯•åœºæ™¯

1. **å–æ¶ˆåœºæ™¯**ï¼šå¯åŠ¨ä¸€ä¸ªåŒ…å«å¤šä¸ªç®—å­çš„æµç¨‹ï¼Œåœ¨ä¸­é—´å–æ¶ˆï¼ŒéªŒè¯æ‰€æœ‰èµ„æºæ­£ç¡®é‡Šæ”¾
2. **å¹¶å‘åœºæ™¯**ï¼šåŒæ—¶å¯åŠ¨å¤šä¸ªæµç¨‹æ‰§è¡Œï¼ŒéªŒè¯çº¿ç¨‹å®‰å…¨
3. **é”™è¯¯æ¢å¤**ï¼šæ¨¡æ‹Ÿç®—å­æ‰§è¡Œå¤±è´¥ï¼ŒéªŒè¯é”™è¯¯ä¼ æ’­å’Œæ—¥å¿—è®°å½•

---

## ä¸ƒã€é£é™©è¯„ä¼°ä¸å›æ»šæ–¹æ¡ˆ

### 7.1 é£é™©åˆ†æ

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| å–æ¶ˆé€»è¾‘å¼•å…¥ç«æ€æ¡ä»¶ | ä¸­ | é«˜ | ä»£ç å®¡æŸ¥ + å•å…ƒæµ‹è¯• |
| WebMessage è·¯ç”±æ”¹åŠ¨å½±å“ç°æœ‰åŠŸèƒ½ | ä½ | ä¸­ | å‘åå…¼å®¹ + åŠŸèƒ½æµ‹è¯• |
| æ—¥å¿—ä¿®æ”¹å½±å“æ€§èƒ½ | ä½ | ä½ | åŸºå‡†æµ‹è¯• |

### 7.2 å›æ»šæ–¹æ¡ˆ

- æ‰€æœ‰ä¿®æ”¹éƒ½åº”åœ¨ç‰¹æ€§åˆ†æ”¯ä¸Šè¿›è¡Œ
- æ¯ä¸ªä¿®å¤å•ç‹¬æäº¤ï¼Œä¾¿äº cherry-pick å›æ»š
- ä¿ç•™åŸæœ‰ä»£ç ä½œä¸ºæ³¨é‡Šï¼Œä¾¿äºå¿«é€Ÿæ¢å¤

---

## å…«ã€å®Œæˆæ ‡å‡†

### 8.1 ä»£ç å±‚é¢
- [ ] æ‰€æœ‰ P0 å’Œ P1 é—®é¢˜å·²ä¿®å¤
- [ ] æ–°ä»£ç ç¬¦åˆ .editorconfig è§„èŒƒ
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] ä»£ç è¦†ç›–ç‡ä¸é™ä½

### 8.2 åŠŸèƒ½å±‚é¢
- [ ] æµç¨‹å–æ¶ˆåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] æ—¥å¿—æ­£ç¡®è¾“å‡ºåˆ° Serilog æ–‡ä»¶
- [ ] WebMessage é€šä¿¡æ­£å¸¸
- [ ] æ— å›å½’é—®é¢˜

### 8.3 æ–‡æ¡£å±‚é¢
- [ ] æ›´æ–° CHANGELOG.md
- [ ] æ›´æ–° TODO.md æ ‡è®°å·²å®Œæˆé—®é¢˜
- [ ] æ·»åŠ æ¶æ„å†³ç­–è®°å½•ï¼ˆADRï¼‰è¯´æ˜å–æ¶ˆæœºåˆ¶è®¾è®¡

---

## ä¹ã€é™„å½•

### 9.1 ç›¸å…³æ–‡ä»¶æ¸…å•

```
Acme.Product/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Acme.Product.Desktop/
â”‚   â”‚   â”œâ”€â”€ WebView2Host.cs              # P1-003, P2-001
â”‚   â”‚   â””â”€â”€ Program.cs
â”‚   â”œâ”€â”€ Acme.Product.Infrastructure/
â”‚   â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â”‚   â”œâ”€â”€ FlowExecutionService.cs  # P0-001
â”‚   â”‚   â”‚   â””â”€â”€ ImageAcquisitionService.cs # P1-001, P2-002
â”‚   â”‚   â””â”€â”€ Repositories/
â”‚   â”‚       â””â”€â”€ ProjectRepository.cs     # P1-002
â”‚   â””â”€â”€ Acme.Product.Core/
â”‚       â””â”€â”€ Services/
â”‚           â””â”€â”€ IFlowExecutionService.cs
â””â”€â”€ tests/
    â””â”€â”€ Acme.Product.Tests/
```

### 9.2 å‚è€ƒæ–‡æ¡£

- [ä»£ç å®è·µæŒ‡å¯¼.md](./ä»£ç å®è·µæŒ‡å¯¼.md)
- [TODO.md](./TODO.md)
- Microsoft WebView2 å®˜æ–¹æ–‡æ¡£
- .NET 8 CancellationToken æœ€ä½³å®è·µ
- Serilog ç»“æ„åŒ–æ—¥å¿—æŒ‡å—

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*  
*æœ€åæ›´æ–°: 2026-02-08*  
*ç»´æŠ¤è€…: AI Assistant*
